{
  "$schema": "https://raw.githubusercontent.com/devcontainers/spec/main/schemas/devContainer.schema.json",
  "name": "Journiv Development",
  "build": {
    "dockerfile": "../Dockerfile",
    "context": "..",
    "target": "dev"
  },
  "workspaceFolder": "/app",

  // Use shared development environment file
  "runArgs": ["--env-file", "${localWorkspaceFolder}/.env.dev"],

  // Post-start command to ensure directories exist, install git-lfs, and setup shell
  "postStartCommand": "sudo apk add --no-cache git-lfs && git lfs install && mkdir -p /data/media /data/logs && (command -v starship >/dev/null 2>&1 || (curl -sS https://starship.rs/install.sh | sh -s -- -y && echo 'eval \"$(starship init bash)\"' >> ~/.bashrc))",

  // Override the default CMD to not start the server automatically
  "overrideCommand": true,

  // VS Code customizations
  "customizations": {
    "vscode": {
      // Extensions to install
      "extensions": [
        // Dev Containers
        "ms-vscode-remote.remote-containers",

        // Python development
        "ms-python.python",
        "ms-python.vscode-pylance",
        "ms-python.debugpy",

        // Code formatting and linting
        "ms-python.black-formatter",
        "ms-python.isort",
        "ms-python.flake8",

        // Docker support
        "ms-azuretools.vscode-docker",

        // Database tools
        "mtxr.sqltools",
        "mtxr.sqltools-driver-sqlite",
        "mtxr.sqltools-driver-pg",

        // Git tools
        "eamodio.gitlens",

        // YAML support
        "redhat.vscode-yaml",

        // Environment file support
        "mikestead.dotenv",

        // General productivity
        "aaron-bond.better-comments",
        "usernamehw.errorlens",
        "streetsidesoftware.code-spell-checker"
      ],

      // Settings
      "settings": {
        // Python configuration
        "python.defaultInterpreterPath": "/usr/local/bin/python",
        "python.linting.enabled": true,
        "python.linting.pylintEnabled": false,
        "python.linting.flake8Enabled": true,
        "python.formatting.provider": "none",
        "python.analysis.typeCheckingMode": "basic",
        "python.analysis.autoImportCompletions": true,
        "python.testing.pytestEnabled": true,
        "python.testing.unittestEnabled": false,
        "python.testing.pytestArgs": [
          "."
        ],

        // Black formatter
        "[python]": {
          "editor.formatOnSave": true,
          "editor.codeActionsOnSave": {
            "source.organizeImports": "explicit"
          }
        },
        "black-formatter.args": [
          "--line-length=88"
        ],
        "isort.args": [
          "--profile", "black"
        ],

        // Editor settings
        "editor.rulers": [88],
        "editor.tabSize": 4,
        "editor.insertSpaces": true,
        "files.trimTrailingWhitespace": true,
        "files.insertFinalNewline": true,

        // File associations
        "files.associations": {
          "*.env*": "dotenv",
          "docker-compose*.yml": "yaml",
          "Dockerfile*": "dockerfile"
        },

        // SQLTools configuration for SQLite
        "sqltools.connections": [
          {
            "name": "Journiv SQLite (Dev)",
            "driver": "SQLite",
            "database": "/data/journiv.db",
            "previewLimit": 50
          }
        ],

        // Terminal
        "terminal.integrated.defaultProfile.linux": "bash",
        "terminal.integrated.cwd": "/app"
      }
    }
  },

  // Forward ports for the application
  "forwardPorts": [8000],
  "portsAttributes": {
    "8000": {
      "label": "Journiv API",
      "onAutoForward": "notify"
    }
  },

  // Container user
  "remoteUser": "appuser",

  // Minimal container env (most come from .env.dev)
  "containerEnv": {},

  // Mount the Docker socket and data directory
  "mounts": [
    "source=/var/run/docker.sock,target=/var/run/docker.sock,type=bind",
    "source=${localWorkspaceFolder}/data,target=/data,type=bind"
  ],

  // No additional features needed (git-lfs installed via postStartCommand)
  "features": {}
}
