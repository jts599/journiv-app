# Journiv Production Docker Compose
#
# Deployment Options:
# 1. SQLite (default): docker-compose up -d
# 2. PostgreSQL: docker-compose --profile postgres up -d
#
# Required Environment Variables:
# - SECRET_KEY: Generate with: python -c "import secrets; print(secrets.token_urlsafe(32))" or openssl rand -base64 32
# - DOMAIN_NAME: Your Journiv domain when operating in same-origin SPA mode (ENABLE_CORS=false).
#   Leave blank to auto-detect container hostname (falls back to localhost).
#
# Optional Environment Variables:
# - APP_PORT: Application port (default: 8000)
# - DATABASE_URL: Database URL (default: SQLite)
# - POSTGRES_*: PostgreSQL configuration
# - ENABLE_CORS: Set to true for cross-origin API access (mobile/web clients on different origins)
# - CORS_ORIGINS: Required when ENABLE_CORS=true (comma-separated origins)
# - MAX_FILE_SIZE_MB: Max file upload size (default: 50)
# - LOG_LEVEL: Logging level (default: INFO)
# - SKIP_DB_INIT: Skip database migrations in workers (default: true). Migrations run via entrypoint script.

services:
  app:
    image: swalabtech/journiv-app:latest
    container_name: journiv-sqlite-app
    ports:
      - "${APP_PORT:-8000}:${APP_PORT:-8000}"
    environment:
      # Database Configuration
      - DATABASE_URL=${DATABASE_URL:-sqlite:////data/journiv.db}
      # PostgreSQL override (optional)
      - POSTGRES_URL=${POSTGRES_URL:-}
      - POSTGRES_HOST=${POSTGRES_HOST:-}
      - POSTGRES_USER=${POSTGRES_USER:-}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-}
      - POSTGRES_DB=${POSTGRES_DB:-}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      # Security
      - SECRET_KEY=${SECRET_KEY}
      - DOMAIN_NAME=${DOMAIN_NAME:-}
      - ENABLE_CORS=${ENABLE_CORS:-false}
      - CORS_ORIGINS=${CORS_ORIGINS:-}
      - ALGORITHM=${ALGORITHM:-HS256}
      # CSP Configuration
      - ENABLE_CSP=${ENABLE_CSP:-true}
      - ENABLE_HSTS=${ENABLE_HSTS:-true}
      - ENABLE_CSP_REPORTING=${ENABLE_CSP_REPORTING:-true}
      - CSP_REPORT_URI=${CSP_REPORT_URI:-/api/v1/security/csp-report}
      # Application Settings
      - APP_NAME=${APP_NAME:-Journiv}
      - APP_VERSION=${APP_VERSION:-0.1.0-beta.1}
      - DEBUG=false
      - ENVIRONMENT=development
      - API_V1_PREFIX=${API_V1_PREFIX:-/api/v1}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES:-15}
      - REFRESH_TOKEN_EXPIRE_DAYS=${REFRESH_TOKEN_EXPIRE_DAYS:-7}
      # Media Configuration
      - MEDIA_ROOT=/data/media
      - LOG_DIR=/data/logs
      - MAX_FILE_SIZE_MB=${MAX_FILE_SIZE_MB:-50}
      - ALLOWED_MEDIA_TYPES=image/jpeg,image/png,image/gif,image/webp,video/mp4,video/avi,video/mov,video/webm,audio/mpeg,audio/wav,audio/ogg,audio/m4a,audio/aac
      - ALLOWED_FILE_EXTENSIONS=.jpg,.jpeg,.png,.gif,.webp,.mp4,.avi,.mov,.webm,.mp3,.wav,.ogg,.m4a,.aac
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FILE=${LOG_FILE:-}
    volumes:
      - app_data:/data
    networks:
      - backend
      - frontend
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "curl",
          "-f",
          "http://localhost:${APP_PORT:-8000}/api/v1/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          cpus: "1"
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    profiles:
      - default
      - sqlite

  # PostgreSQL service (optional - for advanced users)
  postgres:
    image: postgres:15
    container_name: journiv-postgres
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-journiv}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-journiv_password}
      - POSTGRES_DB=${POSTGRES_DB:-journiv_prod}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    networks:
      - backend
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    profiles:
      - postgres

  # Application with PostgreSQL
  app-postgres:
    build:
      context: .
      dockerfile: Dockerfile
    image: journiv-app
    container_name: journiv-postgres-app
    ports:
      - "${APP_PORT:-8000}:${APP_PORT:-8000}"
    environment:
      # Use PostgreSQL
      - POSTGRES_HOST=postgres
      - POSTGRES_USER=${POSTGRES_USER:-journiv}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-journiv_password}
      - POSTGRES_DB=${POSTGRES_DB:-journiv_prod}
      - POSTGRES_PORT=5432
      # Security
      - SECRET_KEY=${SECRET_KEY}
      - DOMAIN_NAME=${DOMAIN_NAME:-}
      - ENABLE_CORS=${ENABLE_CORS:-false}
      - CORS_ORIGINS=${CORS_ORIGINS:-}
      - ALGORITHM=${ALGORITHM:-HS256}
      # CSP Configuration
      - ENABLE_CSP=${ENABLE_CSP:-true}
      - ENABLE_HSTS=${ENABLE_HSTS:-true}
      - ENABLE_CSP_REPORTING=${ENABLE_CSP_REPORTING:-true}
      - CSP_REPORT_URI=${CSP_REPORT_URI:-/api/v1/security/csp-report}
      # Application Settings
      - APP_NAME=${APP_NAME:-Journiv}
      - APP_VERSION=${APP_VERSION:-0.1.0-beta.1}
      - DEBUG=false
      - ENVIRONMENT=development
      - API_V1_PREFIX=${API_V1_PREFIX:-/api/v1}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES:-15}
      - REFRESH_TOKEN_EXPIRE_DAYS=${REFRESH_TOKEN_EXPIRE_DAYS:-7}
      # Media Configuration
      - MEDIA_ROOT=/data/media
      - LOG_DIR=/data/logs
      - MAX_FILE_SIZE_MB=${MAX_FILE_SIZE_MB:-50}
      - ALLOWED_MEDIA_TYPES=image/jpeg,image/png,image/gif,image/webp,video/mp4,video/avi,video/mov,video/webm,audio/mpeg,audio/wav,audio/ogg,audio/m4a,audio/aac
      - ALLOWED_FILE_EXTENSIONS=.jpg,.jpeg,.png,.gif,.webp,.mp4,.avi,.mov,.webm,.mp3,.wav,.ogg,.m4a,.aac
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FILE=${LOG_FILE:-}
    volumes:
      - app_data:/data
    depends_on:
      - postgres
    networks:
      - backend
      - frontend
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "curl",
          "-f",
          "http://localhost:${APP_PORT:-8000}/api/v1/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          cpus: "1"
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    profiles:
      - postgres

volumes:
  app_data:
  postgres_data:

networks:
  backend:
    driver: bridge
  frontend:
    driver: bridge
